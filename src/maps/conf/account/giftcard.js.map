{"version":3,"sources":["conf/account/giftcard.js"],"names":["define","require","exports","module","$","Vue","UI","ajax","storage","commonMod","states","bindCopyEvents","renderCompleted","cardListRes","data","totalExchange","amount","myGiftCards","showHelpLayer","targetCardId","targetUseStatus","vm","el","computed","sortedListData","getCompareFunc","tarAttr","i1","i2","valueOf","arr","filter","i","exchangeStatus","useStatus","r1","r2","r3","_r1","sort","_r2","_r3","concat","methods","fetchGiftCardsData","query","url","pageNum","pageSize","success","res","code","$nextTick","checkIfShouldShowTutorial","scrollIntoTargetSelector","error","attachLongPressEvt","fn","startTimeStamp","endTimeStamp","startX","startY","$body","on","evt","targetTouches","clientX","clientY","Date","$tar","target","fingerDidNotMove","Math","abs","changedTouches","pressedTimeEnough","children","show","find","hide","sendSwitchUseStatusReq","put","cardId","toString","alertSecond","getItem","not","length","document","body","scrollTop","showTutorial","setItem","init","setFilters","created","ready","script","createElement","async","src","getElementsByTagName","appendChild","onload","copyButtons","querySelectorAll","c","Clipboard","e","clearSelection"],"mappings":"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","file":"../../../js_es6/conf/account/giftcard.js","sourcesContent":["/**\n * 我的礼品卡 - h5\n * @author 张恩铭\n * @date 20170324\n * 页面引用\n *  <script src=\"__PUBLIC__/js/lithe.js\"\n data-config=\"config.js\"\n data-debug=\"true\"\n data-main=\"conf/account/giftcard.js\">\n </script>\n */\ndefine('conf/account/giftcard.js', function(require, exports, module) {\n    const $ = require('$');\n    const Vue = require('vue');\n    const UI = require('UI/dialog/alert');\n    const ajax = require('utils/async/ajax.js');\n    const storage = require('mods/storage/storage');\n\n    const commonMod = require('conf/account/_common.js');\n\n    $(function() {\n\n        let states = {\n            // 公共方法\n            commonMod,\n            // 复制方法\n            bindCopyEvents,\n            // 首次渲染完成\n            renderCompleted: false,\n            // 我的礼品卡列表数据\n            cardListRes: {\n                data: {\n                    totalExchange: {\n                        amount: 0,\n                    },\n                    myGiftCards: [],\n                },\n            },\n            // 展示帮助浮层\n            showHelpLayer: false,\n            // 目标卡id\n            targetCardId: '',\n            // 目标卡使用状态\n            targetUseStatus: null,\n        };\n\n        let vm = new Vue({\n            el: 'body',\n            data() {\n                return states;\n            },\n            computed: {\n                sortedListData() {\n                    const getCompareFunc = function(tarAttr) {\n                        return function(i1, i2) {\n                            return -(i1[tarAttr].valueOf() - i2[tarAttr].valueOf());\n                        };\n                    };\n                    /*\n                    先去除已解绑的卡和旧版本的卡（后者理论上不会出现）\n                    然后按 未使用 > 未激活 > 已使用 排序\n                    */\n                    let arr = this.cardListRes.data.myGiftCards.filter((i) => {\n                        return i.exchangeStatus !== 'UNBIND' && i.useStatus !== 'NO_USERED';\n                    });\n                    let r1 = arr.filter((i) => {\n                        return i.useStatus === 'UNUSED' && i.exchangeStatus === 'ALREADY_EXCHANGE';\n                    });\n                    let r2 = arr.filter((i) => {\n                        return i.exchangeStatus === 'ALREADY_BIND';\n                    });\n                    let r3 = arr.filter((i) => {\n                        return i.useStatus === 'USED';\n                    });\n                    // console.log('all\\n', this.cardListRes.data.myGiftCards);\n                    // console.log('r1\\n', r1);\n                    // console.log('r2\\n', r2);\n                    // console.log('r3\\n', r3);\n                    // console.log('arr', arr);\n                    let _r1 = r1.sort(getCompareFunc('exchangeDate')),\n                        _r2 = r2.sort(getCompareFunc('distributeDate')),\n                        _r3 = r3.sort(getCompareFunc('exchangeDate'));\n                    return _r1.concat(_r2).concat(_r3);\n                },\n            },\n            methods: {\n                /*\n                更新礼品卡列表数据，成功后绑定复制事件，判断是否展示使用说明\n                */\n                fetchGiftCardsData() {\n                    // this.renderCompleted = false;\n                    ajax.query({\n                        url: '/api/trade/myGiftCards',\n                        data: {\n                            pageNum: 0,\n                            pageSize: 0,\n                        },\n                        success(res) {\n                            if (res.code === 200) {\n                                vm.cardListRes = res;\n                                vm.$nextTick(function() {\n                                    vm.checkIfShouldShowTutorial();\n                                    vm.bindCopyEvents();\n                                })\n                            }\n                            vm.renderCompleted = true;\n                            if (vm.targetCardId !== '') {\n                                commonMod.scrollIntoTargetSelector('[data-is-scroll-target]');\n                            }\n                        },\n                        error() {\n                            vm.renderCompleted = true;\n                        },\n                    });\n                },\n                /*\n                ‘长按’事件的触发\n                */\n                attachLongPressEvt(fn) {\n                    let startTimeStamp,\n                        endTimeStamp,\n                        startX,\n                        startY;\n                    let $body = $('body');\n                    $body.on('touchstart', '.cards-li', function(evt) {\n                            startX = evt.targetTouches[0].clientX;\n                            startY = evt.targetTouches[0].clientY;\n                            startTimeStamp = new Date().valueOf();\n                            // 如果目标有card-id属性，说明事件发生在改使用状态的按钮上\n                            // 保存该id，并设置vm.targetUseStatus与data-use-status相反\n                            let $tar = $(evt.target);\n                            vm.targetCardId = $tar.data('card-id') || '';\n                            vm.targetUseStatus = $tar.data('use-status') === 'USED'\n                                ? 'UNUSED'\n                                : 'USED';\n                        })\n                        .on('touchend', '.cards-li', function(evt) {\n                            // 如果事件目标的id存在且与已保存的id相同，说明该按钮上产生了点击事件。触发fn；\n                            if ($(evt.target).data('card-id') === vm.targetCardId) {\n                                fn();\n                            // 否则按以下2个条件判断是否发生了‘长按’事件\n                            } else {\n                                endTimeStamp = new Date().valueOf();\n                                // - 水平和垂直的偏移量均小于10\n                                let fingerDidNotMove =\n                                    Math.abs(evt.changedTouches[0].clientY - startY) < 10\n                                    && Math.abs(evt.changedTouches[0].clientX - startX) < 10;\n                                // - 持续时间大于500\n                                let pressedTimeEnough =\n                                    endTimeStamp - startTimeStamp > 200;\n                                if (fingerDidNotMove && pressedTimeEnough) {\n                                    $(this).children('.mark-wrap').show();\n                                } else {\n                                    $body.find('.mark-wrap').hide();\n                                }\n                            }\n                        });\n                },\n                /*\n                发送更改使用状态的请求。返回成功则更新礼品卡列表数据\n                */\n                sendSwitchUseStatusReq() {\n                    ajax.put({\n                        url: '/api/trade/myGiftCard',\n                        data: {\n                            cardId: vm.targetCardId.toString(),\n                            useStatus: vm.targetUseStatus,\n                        },\n                        success(res) {\n                            if (res.code === 200) {\n                                vm.fetchGiftCardsData();\n                            } else {\n                                UI.alertSecond(\"Change use status failed\");\n                            }\n                        },\n                        error() {},\n                    });\n                },\n                /*\n                初次出现非.disabled的.cards-li元素时展示使用说明，关闭说明后在ls中保存，之后不再出现\n                */\n                checkIfShouldShowTutorial() {\n                    if (storage.getItem('hadSeenTutorial') === null) {\n                        if ($('body').find('.cards-li').not('.disabled').length > 0) {\n                            document.body.scrollTop = 0;\n                            commonMod.showTutorial(\n                                '.cards-li',\n                                'Long press to mark the usage of Gift Card.',\n                                function() {\n                                    storage.setItem('hadSeenTutorial', true);\n                                }\n                            );\n                        };\n                    }\n                },\n\n            },\n            /*\n            注册过滤器\n            */\n            init() {\n                commonMod.setFilters();\n            },\n            /*\n            更新数据\n            */\n            created() {\n                this.fetchGiftCardsData();\n            },\n            /*\n            注册长按事件\n            */\n            ready() {\n                this.attachLongPressEvt(this.sendSwitchUseStatusReq);\n            },\n        });\n\n        function bindCopyEvents() {\n            // H5站暂时用cdn上的clipboard.js\n            let script = document.createElement('script');\n            script.async = \"async\";\n            script.src = 'https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js';\n            document.getElementsByTagName(\"head\")[0].appendChild(script);\n            script.onload = function() {\n                // require('utils/clipboard.js');\n                let copyButtons = document.querySelectorAll('.copy-btn');\n                let c = new Clipboard(copyButtons);\n                c.on('success', function(e) {\n                    UI.alertSecond(\"Copied\");\n                    e.clearSelection();\n                });\n                c.on('error', function(e) {\n                    UI.alertSecond(\"Auto-copy failed. Please copy manually.\");\n                });\n            }\n        }\n\n    });\n});\n"]}