{"version":3,"sources":["conf/login/fbLog.js"],"names":["define","require","exports","module","check","ajax","storage","fbLog","$","on","ga","FB","getLoginStatus","checkLoginStatus","response","status","login","authResponse","userInfo","id","userID","thirdPartyAccountType","thirdPartyAccessToken","accessToken","api","fields","setItem","checkBound","scope","_url","query","url","success","data","code","isBound","location","replace","assign","error"],"mappings":"AAAA;AACA;;;;;;;;;;;;AAYAA,OAAO,qBAAP,EAA8B,UAAUC,OAAV,EAAmBC,OAAnB,EAA4BC,MAA5B,EAAoC;AACjEF,SAAQ,GAAR;AACA,KAAMG,QAAQH,QAAQ,qBAAR,CAAd;AAAA,KACCI,OAAOJ,QAAQ,qBAAR,CADR;AAAA,KAECK,UAAUL,QAAQ,sBAAR,CAFX;AAAA,KAGCM,QAAQC,EAAE,mBAAF,CAHT;;AAKAD,OAAME,EAAN,CAAS,OAAT,EAAiB,GAAjB,EAAqB,YAAM;AAC1B;;AAEMC,KAAG,MAAH,EAAW,OAAX,EAAoB,YAApB,EAAkC,oBAAlC;AACNC,KAAGC,cAAH,CAAkBC,gBAAlB;AACA,EALD;;AAOA,KAAIA,mBAAmB,SAAnBA,gBAAmB,CAACC,QAAD,EAAc;AACpC,MAAGA,SAASC,MAAT,KAAoB,WAAvB,EAAmC;AAClC;AACAJ,MAAGK,KAAH,CAAS,UAASF,QAAT,EAAkB;AACzB,QAAI,CAACA,SAASG,YAAd,EAA4B;AAC3B;AACA;AACA;AACD,QAAIC,WAAW;AACdC,SAAGL,SAASG,YAAT,CAAsBG,MADX;AAEdC,4BAAsB,UAFR;AAGdC,4BAAsBR,SAASG,YAAT,CAAsBM;AAH9B,KAAf;AAKA,QAAIA,cAAcT,SAASG,YAAT,CAAsBM,WAAxC;AACA;AACAZ,OAAGa,GAAH,CAAO,KAAP,EAAa,EAACC,QAAO,0BAAR,EAAb,EAAiD,UAAUX,QAAV,EAAmB;AACnER,aAAQoB,OAAR,CAAgB,aAAhB,EAA8BZ,QAA9B;AACAa,gBAAWT,QAAX;AACA,KAHD;AAID,IAhBD,EAgBE,EAACU,OAAM,mCAAP,EAhBF;AAiBA,GAnBD,MAmBK;AAAA;AACJ,QAAIV,WAAW;AACZC,SAAGL,SAASG,YAAT,CAAsBG,MADb;AAEZC,4BAAsB,UAFV;AAGZC,4BAAsBR,SAASG,YAAT,CAAsBM;AAHhC,KAAf;AAKAZ,OAAGa,GAAH,CAAO,KAAP,EAAa,EAACC,QAAO,0BAAR,EAAb,EAAiD,UAAUX,QAAV,EAAmB;AACjER,aAAQoB,OAAR,CAAgB,aAAhB,EAA8BZ,QAA9B;AACAa,gBAAWT,QAAX;AACF,KAHD;AANI;AAUJ;AACD,EA/BD;;AAiCA,KAAIS,aAAa,SAAbA,UAAa,CAACT,QAAD,EAAc;AAC9B,MAAIW,OAAO,yCAAuCX,SAASC,EAAhD,GAAmD,yBAAnD,GAA6ED,SAASI,qBAAtF,GAA4G,yBAA5G,GAAsIJ,SAASG,qBAA1J;AACAhB,OAAKyB,KAAL,CAAW;AACDC,QAAIF,IADH;AAEDG,YAAS,iBAACC,IAAD,EAAU;AACf,QAAIA,KAAKC,IAAL,KAAc,GAAlB,EAAuB;AACtB,SAAID,KAAKA,IAAL,CAAUE,OAAd,EAAuB;AACtB;AACAC,eAASC,OAAT,CAAiB,GAAjB;AACA,MAHD,MAGK;AACJ;AACA/B,cAAQoB,OAAR,CAAgB,UAAhB,EAA2BR,QAA3B;AACAkB,eAASE,MAAT,CAAgB,mBAAhB;AACA;AACD,KATD,MASO,CAEN;AACJ,IAfA;AAgBDC,UAAM,iBAAM,CAAE;AAhBb,GAAX;AAkBA,EApBD;AAqBA,CApED","file":"../../../js_es6/conf/login/fbLog.js","sourcesContent":["'use strict';\n/**\n * facebook 第三方登录/注册\n * @author lixuefeng\n * @date 20170228\n * 页面引用\n * <script src=\"__PUBLIC__/js/lithe.js\"\n data-config=\"config.js\"\n data-debug=\"true\"\n data-main=\"conf/login/fbLog.js\">\n </script>\n*/\n\ndefine('conf/login/fbLog.js', function (require, exports, module) {\n\trequire('$');\n\tconst check = require('mods/check/input.js'),\n\t\tajax = require('utils/async/ajax.js'),\n\t\tstorage = require('mods/storage/storage'),\n\t\tfbLog = $('[data-node=fbLog]');\n\n\tfbLog.on('click','a',() => {\n\t\t//埋点\n       \n        ga('send', 'event', 'login/sign', 'login_fb_btn_click');\n\t\tFB.getLoginStatus(checkLoginStatus);\n\t})\n\n\tlet checkLoginStatus = (response) => {\n\t\tif(response.status !== \"connected\"){\n\t\t\t//拉取facebook登录页面\n\t\t\tFB.login(function(response){\n\t\t\t  if( !response.authResponse ){\n\t\t\t  \t//用户是否取消操作\n\t\t\t  \treturn;\n\t\t\t  }\n\t\t\t  let userInfo = {\n\t\t  \t\tid:response.authResponse.userID,\n\t\t  \t\tthirdPartyAccountType:\"FACEBOOK\",\n\t\t  \t\tthirdPartyAccessToken:response.authResponse.accessToken\n\t\t\t  }\n\t\t\t  let accessToken = response.authResponse.accessToken;\n\t\t\t  //获取用户信息\n\t\t\t  FB.api('/me',{fields:'name,cover,picture,email'},function (response){\n\t\t\t  \tstorage.setItem('ascUserInfo',response);\n\t\t\t  \tcheckBound(userInfo);\n\t\t\t  })\n\t\t\t},{scope:\"user_friends,email,public_profile\"});\n\t\t}else{\n\t\t\tlet userInfo = {\n\t\t  \t\tid:response.authResponse.userID,\n\t\t  \t\tthirdPartyAccountType:\"FACEBOOK\",\n\t\t  \t\tthirdPartyAccessToken:response.authResponse.accessToken\n\t\t\t}\n\t\t\tFB.api('/me',{fields:'name,cover,picture,email'},function (response){\n\t\t\t  \tstorage.setItem('ascUserInfo',response);\n\t\t\t  \tcheckBound(userInfo);\n\t\t\t});\n\t\t}\t\n\t}\n\n\tlet checkBound = (userInfo) => {\n\t\tlet _url = '/api/user/thirdPartyAccountLogin?id='+userInfo.id+'&thirdPartyAccessToken='+userInfo.thirdPartyAccessToken+'&thirdPartyAccountType='+userInfo.thirdPartyAccountType;\n\t\tajax.query({\n            url:_url,\n            success: (data) => {\n                if (data.code === 200) {\n                \tif( data.data.isBound ){\n                \t\t//第三方登录\n                \t\tlocation.replace('/');\n                \t}else{\n                \t\t//第三方注册\n                \t\tstorage.setItem('ascToken',userInfo);\n                \t\tlocation.assign('/login/associated');\n                \t}\n                } else {\n\n                }\n            },\n            error:() => {}\n        });\n\t}\n})\n"]}