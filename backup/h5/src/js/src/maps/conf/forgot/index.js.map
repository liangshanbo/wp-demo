{"version":3,"sources":["conf/forgot/index.js"],"names":["define","require","exports","module","check","UI","ajax","sendVerification","storage","phone","$","send","verification","next","isHigh","stoken","init","bindEvents","on","val","length","addClass","removeClass","nextHigh","obj","hasClass","isMobile","alertSecond","checkPhone","token","setItem","Date","getItem","removeItem","mobile","smsCode","smsToken","children","checkVerification","put","url","data","success","code","location","assign","message","error"],"mappings":"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","file":"../../../../conf/forgot/index.js","sourcesContent":["/**\n * 忘记密码脚本\n * @author 黄奕海\n * @date 20170220\n * 页面引用\n *  <script src=\"__PUBLIC__/js/lithe.js\"\n data-config=\"config.js\"\n data-debug=\"true\"\n data-main=\"conf/forgot/index.js\">\n </script>\n */\ndefine('conf/forgot/index.js',function(require,exports,module) {\n    const check=require('mods/check/input.js'),\n        UI = require('UI/dialog/alert.js'),\n        ajax = require('utils/async/ajax.js'),\n        sendVerification = require('mods/send_verification'),\n        storage = require('mods/storage/storage');\n    require('$');\n    let phone = $('#username'),\n        send = $('#send'),\n        verification = $('#verification'),\n        next = $('#next'),\n        isHigh = {phone:false,verification:false},\n        stoken;\n    init();\n    function init(){\n        bindEvents();\n    }\n    function bindEvents(){\n        phone.on('input',function(){\n            let val = phone.val();\n            if(val.length >= 10){\n                isHigh.phone = true;\n                send.addClass('verification-active');\n            }else{\n                isHigh.phone = false;\n                send.removeClass('verification-active');\n            }\n            nextHigh();\n        });\n        verification.on('input',function(){\n            let val = verification.val();\n            if(val.length>=6){\n                isHigh.verification = true;\n            }else{\n                isHigh.verification = false;\n            }\n            nextHigh();\n        });\n        send.on('click', function () {\n            const obj = {\n                \"mobile\" : phone.val(),\n                \"type\" : \"FINDPWD\"\n            };\n            if (!send.hasClass('verification-active')) {\n                return;\n            }\n            if(!check.isMobile(phone.val())){\n                UI.alertSecond('Phone number format error');\n                return;\n            }\n            send.removeClass('verification-active');\n            sendVerification.checkPhone(send, obj, 60,function(token){\n                stoken = token;\n                storage.setItem(\"fst\"+phone.val(),token);//forgot stoken\n                storage.setItem(\"fsttime\",new Date()*1);//forgot time\n            });\n        });\n        next.on('click',function(){\n            if(new Date() * 1 - storage.getItem('fsttime') <= 600000 && storage.getItem('fst'+phone.val())){\n                stoken = storage.getItem(\"fst\"+phone.val());\n            }else{\n                storage.removeItem(\"fst\"+phone.val());\n                storage.removeItem(\"fsttime\");\n            }\n            var mobile = phone.val();\n            const obj = {\n                smsCode : verification.val(),\n                smsToken : stoken,\n                mobile : mobile\n            };\n            if(next.children('a').hasClass('disabled')){\n                return ;\n            }\n            if (!check.isMobile(mobile)) {\n                UI.alertSecond('Phone number format error');\n                return;\n            }\n            checkVerification(obj);\n        })\n    }\n    //下一步按钮高亮\n    function nextHigh(){\n        if(isHigh.phone && isHigh.verification){\n            next.children('a').removeClass('disabled');\n        }else{\n            next.children('a').addClass('disabled');\n        }\n    }\n    //校验手机验证码是否正确\n    function checkVerification(obj){\n        ajax.put({\n            url:'/api/user/sms',\n            data:obj,\n            success:function(data){\n                if(data.code === 200){\n                    storage.setItem('fphone',phone.val());\n                    storage.setItem('sst',data.data.smsToken); //setpwd token;\n                    storage.setItem('ssttime',new Date() * 1); //setpwd time;\n                    location.assign('/forgot/setpwd');\n                }else{\n                    UI.alertSecond(data.message);\n                }\n            },\n            error:function(){\n\n            }\n        })\n    }\n});\n"]}