{"version":3,"sources":["utils/async/dropload.js"],"names":["define","require","exports","module","Ajax","ll","current_element","DropLoad","selector","url","params","callback","options","element","document","querySelector","isGoOn","_init","_addListener","console","log","_lazyload","len","_loadover","Object","assign","pageNum","loadDiv","current","isLoading","isFinished","isHideOver","create","numPerPage","defaults","isFirst","text","overtext","img","wapcsspath","_checkFirstList","_addLoading","body","scrollTop","window","innerHeight","offsetHeight","_loadSource","x","y","self","addEventListener","e","changedTouches","pageX","pageY","target","durationY","Math","abs","_attachFun","_doLoad","srollTop","height","innerH","range","parseFloat","totalheight","_showLoading","loadmore","_before","bind","_after","_hideLoading","setTimeout","_createLoading","parent","parentNode","createElement","className","innerHTML","nextSibling","insertBefore","appendChild","style","display","tagName","toUpperCase","childCount","Array","prototype","slice","call","childNodes","map","el","nodeType","pageSize"],"mappings":";;;;;;AAAA;;;;;;AAMAA,OAAO,sBAAP,EAA+B,UAASC,OAAT,EAAkBC,OAAlB,EAA2BC,MAA3B,EAAmC;;AAEjEF,SAAQ,uBAAR;AACAA,SAAQ,wBAAR;AACA,KAAIG,OAAOH,QAAQ,qBAAR,CAAX;AAAA,KACCI,KAAKJ,QAAQ,yBAAR,CADN;AAAA,KAECK,kBAAkB,IAFnB;;AAJiE,KAQ3DC,QAR2D;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,0BAUzDC,QAVyD,EAU/CC,GAV+C,EAU1CC,MAV0C,EAUlCC,QAVkC,EAUxBC,OAVwB,EAUf;AAChD,QAAIC,UAAUC,SAASC,aAAT,CAAuBP,QAAvB,CAAd;AACA,QAAIK,OAAJ,EAAa;AACZ,SAAIG,SAAS,KAAKC,KAAL,CAAWJ,OAAX,EAAoBJ,GAApB,EAAyBC,MAAzB,EAAiCC,QAAjC,EAA2CC,OAA3C,CAAb;AACA,SAAGI,MAAH,EAAU;AACT,WAAKE,YAAL;AACA;AACD,KALD,MAKO;AACNC,aAAQC,GAAR,CAAY,2BAAZ;AACA,YAAO,KAAP;AACA;AACD;AArB+D;AAAA;AAAA,8BAuBrD;AACVf,OAAGgB,SAAH;AACA;AAzB+D;AAAA;AAAA,4BA2BvDC,GA3BuD,EA2BlD;AACb,SAAKC,SAAL,CAAeD,GAAf;AACA;AA7B+D;AAAA;AAAA,6BA+BtDV,OA/BsD,EA+B9C;AACjB,SAAKF,MAAL,GAAcc,OAAOC,MAAP,CAAc,KAAKf,MAAnB,EAA0BE,OAA1B,CAAd;AACA;AAjC+D;AAAA;AAAA,iCAmCnD;AACZ,WAAO,KAAKF,MAAL,CAAYgB,OAAnB;AACA;AArC+D;AAAA;AAAA,yBAuC1Db,OAvC0D,EAuCjDJ,GAvCiD,EAuC5CC,MAvC4C,EAuCpCC,QAvCoC,EAuC1BC,OAvC0B,EAuCjB;AAC9C,SAAKH,GAAL,GAAWA,GAAX;AACA,SAAKkB,OAAL,GAAe,IAAf;AACA,SAAKC,OAAL,GAAef,OAAf;AACA,SAAKgB,SAAL,GAAiB,KAAjB;AACA,SAAKC,UAAL,GAAkB,KAAlB;AACA,SAAKC,UAAL,GAAkB,KAAlB;AACA,SAAKpB,QAAL,GAAgBA,QAAhB;AACA,SAAKD,MAAL,GAAcc,OAAOQ,MAAP,CAActB,MAAd,CAAd;AACA,SAAKA,MAAL,CAAYuB,UAAZ,GAAyBvB,OAAOuB,UAAP,IAAqB,EAA9C;AACA,SAAKC,QAAL,GAAgB;AACfC,cAAS,KADM;AAEfC,WAAM,WAFS;AAGfC,eAAU,SAHK;AAIfC,UAAKC,aAAa;AAJH,KAAhB;AAMA,QAAI3B,OAAJ,EAAa;AACZ,UAAKuB,OAAL,GAAevB,QAAQuB,OAAR,IAAmB,KAAlC;AACA,UAAKD,QAAL,GAAgBV,OAAOC,MAAP,CAAc,KAAKS,QAAnB,EAA6BtB,OAA7B,CAAhB;AACA;AACD,QAAI,KAAKsB,QAAL,CAAcC,OAAlB,EAA2B;AAC1B,UAAKzB,MAAL,CAAYgB,OAAZ,GAAsB,CAAtB;AACA,UAAKhB,MAAL,CAAYuB,UAAZ,GAAyB,EAAzB;AACA,KAHD,MAGO;AACN,UAAKvB,MAAL,CAAYgB,OAAZ,GAAsBhB,OAAOgB,OAAP,IAAkB,CAAxC;AACA;AACD,QAAG,KAAKc,eAAL,EAAH,EAA0B;AACzB,YAAO,KAAP;AACA;AACD,SAAKC,WAAL;AACA,QAAG,KAAKb,OAAL,IAAgB,KAAKlB,MAAL,CAAYgB,OAAZ,KAAwB,CAA3C,EAA6C;AAC5C,SAAGZ,SAAS4B,IAAT,CAAcC,SAAd,GAA0BC,OAAOC,WAAjC,KAAiD/B,SAAS4B,IAAT,CAAcI,YAAlE,EAA+E;AAC9E,WAAKC,WAAL;AACA;AACD;AACD,WAAO,IAAP;AACA;AA3E+D;AAAA;AAAA,kCA6EjD;AACd,QAAIC,UAAJ;AAAA,QAAOC,UAAP;AAAA,QAAUC,OAAO,IAAjB;AACA,SAAKtB,OAAL,CAAauB,gBAAb,CAA8B,YAA9B,EAA4C,aAAK;AAChDH,SAAII,EAAEC,cAAF,CAAiB,CAAjB,EAAoBC,KAAxB;AACAL,SAAIG,EAAEC,cAAF,CAAiB,CAAjB,EAAoBE,KAAxB;AACA,KAHD,EAGG,KAHH;AAIA,SAAK3B,OAAL,CAAauB,gBAAb,CAA8B,UAA9B,EAA0C,aAAK;AAC9C7C,uBAAkB8C,EAAEI,MAApB;AACA;AACA,SAAIC,YAAYL,EAAEC,cAAF,CAAiB,CAAjB,EAAoBE,KAApB,GAA4BN,CAA5C;AACA,SAAIS,KAAKC,GAAL,CAASF,SAAT,IAAsB,CAA1B,EAA6B;AAC5BP,WAAKU,UAAL;AACA;AACD,KAPD,EAOG,KAPH;AAQA,QAAI,KAAK1B,QAAL,CAAcC,OAAlB,EAA2B;AAC1B,UAAKY,WAAL;AACA;AACD;AA9F+D;AAAA;AAAA,gCAgGnD;AACZ,QAAI,KAAKjB,UAAT,EAAqB;AACpB;AACA,YAAO,KAAP;AACA;AACD,QAAI,KAAKD,SAAT,EAAoB;AACnB,YAAO,KAAP;AACA;AACD,SAAKgC,OAAL;AACA;AAzG+D;AAAA;AAAA,6BA2GtD;AACT,QAAIC,WAAWhD,SAAS4B,IAAT,CAAcC,SAA7B;AAAA,QACCoB,SAASjD,SAAS4B,IAAT,CAAcI,YADxB;AAAA,QAECkB,SAASpB,OAAOC,WAFjB;AAAA,QAGCoB,QAAQC,WAAWF,MAAX,IAAqB,CAH9B;AAAA,QAICG,cAAcF,QAAQC,WAAWJ,QAAX,CAJvB;AAKA,QAAIK,cAAcF,KAAd,IAAuBF,MAA3B,EAAmC;AAClC,UAAKK,YAAL;AACA,UAAKrB,WAAL;AACA;AACD;AArH+D;AAAA;AAAA,iCAuHlD;AACb3C,SAAKiE,QAAL,CAAc,KAAK5D,GAAnB,EAAwB,KAAKC,MAA7B,EAAqC,KAAKC,QAA1C,EAAoD,KAAK2D,OAAL,CAAaC,IAAb,CAAkB,IAAlB,CAApD,EAA6E,KAAKC,MAAL,CAAYD,IAAZ,CAAiB,IAAjB,CAA7E;AACA;AAzH+D;AAAA;AAAA,6BA2HtD;AACT,SAAKE,YAAL;AACA;AA7H+D;AAAA;AAAA,4BA+HvD;AACR,SAAK/D,MAAL,CAAYgB,OAAZ;AACAgD,eAAW,YAAW;AACrBrE,QAAGgB,SAAH;AACA,KAFD,EAEG,GAFH;AAGA;AApI+D;AAAA;AAAA,iCAsIlD;AACb,QAAI,KAAKM,OAAT,EAAkB;AACjB;AACA,KAFD,MAEO;AACN,UAAKgD,cAAL;AACA;AACD;AA5I+D;AAAA;AAAA,oCA8I/C;AAChB,QAAG,KAAKhD,OAAR,EAAgB;AACf;AACA;AACD,QAAI,KAAKC,OAAT,EAAkB;AACjB,SAAIgD,SAAS,KAAKhD,OAAL,CAAaiD,UAA1B;AAAA,SACClD,UAAUb,SAASgE,aAAT,CAAuB,KAAvB,CADX;AAEAnD,aAAQoD,SAAR,GAAoB,qBAApB;AACApD,aAAQqD,SAAR,GAAoB,mFAAmF,KAAK9C,QAAL,CAAcI,GAAjG,GAAuG,aAAvG,GAAuH,KAAKJ,QAAL,CAAcE,IAAzJ;AACA,SAAI,KAAKR,OAAL,CAAaqD,WAAjB,EAA8B;AAC7B,WAAKtD,OAAL,GAAeiD,OAAOM,YAAP,CAAoBvD,OAApB,EAA6B,KAAKC,OAAL,CAAaqD,WAA1C,CAAf;AACA,MAFD,MAEO;AACN,WAAKtD,OAAL,GAAeiD,OAAOO,WAAP,CAAmBxD,OAAnB,CAAf;AACA;AACD;AACD;AA7J+D;AAAA;AAAA,kCA+JjD;AACd,SAAKA,OAAL,CAAayD,KAAb,CAAmBC,OAAnB,GAA6B,OAA7B;AACA,SAAKxD,SAAL,GAAiB,IAAjB;AACA;AAlK+D;AAAA;AAAA,kCAoKjD;AACd,SAAKF,OAAL,CAAayD,KAAb,CAAmBC,OAAnB,GAA6B,MAA7B;AACA,SAAKxD,SAAL,GAAiB,KAAjB;AACA;AAvK+D;AAAA;AAAA,6BAyKtDP,GAzKsD,EAyKjD;AACd;AACA;AACA;AACA;AACA,QAAI,KAAKK,OAAT,EAAkB;AACjB,UAAKA,OAAL,CAAaqD,SAAb,GAAyB,KAAK9C,QAAL,CAAcG,QAAvC;AACA;AACD,QAAI,KAAKH,QAAL,CAAcH,UAAlB,EAA8B;AAC7B,UAAKJ,OAAL,CAAayD,KAAb,CAAmBC,OAAnB,GAA6B,MAA7B;AACA,KAFD,MAEO;AACN,UAAK1D,OAAL,CAAayD,KAAb,CAAmBC,OAAnB,GAA6B,OAA7B;AACA;AACD,QAAG,KAAK3E,MAAL,CAAYgB,OAAZ,KAAwB,CAAxB,IAA6BJ,QAAQ,CAAxC,EAA0C;AACzC,UAAKK,OAAL,CAAayD,KAAb,CAAmBC,OAAnB,GAA6B,MAA7B;AACA;AACD,SAAKvD,UAAL,GAAkB,IAAlB;AACA;AA1L+D;AAAA;AAAA,qCA4L/C;AAChB,QAAG,KAAKF,OAAL,CAAa0D,OAAb,CAAqBC,WAArB,OAAuC,IAAvC,IAA+C,CAAC,KAAKrD,QAAL,CAAcC,OAAjE,EAAyE;AACxE,SAAIqD,aAAa,CAAjB;AACAC,WAAMC,SAAN,CAAgBC,KAAhB,CAAsBC,IAAtB,CAA2B,KAAKhE,OAAL,CAAaiE,UAAxC,EAAoDC,GAApD,CAAwD,UAASC,EAAT,EAAY;AACnE,UAAGA,GAAGC,QAAH,KAAgB,CAAhB,IAAqBD,GAAGT,OAAH,CAAWC,WAAX,OAA6B,IAArD,EAA0D;AACzDC;AACA;AACD,MAJD;AAKA,SAAGA,aAAa,KAAK9E,MAAL,CAAYuF,QAA5B,EAAqC;AACpC,aAAO,IAAP;AACA;AACD;AACD,WAAO,KAAP;AACA;AAzM+D;;AAAA;AAAA;;AA4MjE9F,QAAOD,OAAP,GAAiBK,QAAjB;AACA,CA7MD","file":"../../../../utils/async/dropload.js","sourcesContent":["/*\r\n    name:dropload.js\r\n    description:上拉加载更多\r\n    anthor:luoxiaowei\r\n    data:2016-11-08\r\n */\r\ndefine(\"utils/async/dropload\", function(require, exports, module) {\r\n\r\n\trequire('lib/polyfill/array.js');\r\n\trequire('lib/polyfill/object.js');\r\n\tlet Ajax = require('utils/async/ajax.js'),\r\n\t\tll = require('utils/async/lazyload.js'),\r\n\t\tcurrent_element = null;\r\n\r\n\tclass DropLoad {\r\n\r\n\t\tupload(selector, url, params, callback, options) {\r\n\t\t\tlet element = document.querySelector(selector);\r\n\t\t\tif (element) {\r\n\t\t\t\tlet isGoOn = this._init(element, url, params, callback, options);\r\n\t\t\t\tif(isGoOn){\r\n\t\t\t\t\tthis._addListener();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconsole.log('error:no selected element');\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlazyload() {\r\n\t\t\tll._lazyload();\r\n\t\t}\r\n\r\n\t\tfinished(len) {\r\n\t\t\tthis._loadover(len);\r\n\t\t}\r\n\r\n\t\tsetParams(options){\r\n\t\t\tthis.params = Object.assign(this.params,options);\r\n\t\t}\r\n\r\n\t\tcurrentPage(){\r\n\t\t\treturn this.params.pageNum;\r\n\t\t}\r\n\r\n\t\t_init(element, url, params, callback, options) {\r\n\t\t\tthis.url = url;\r\n\t\t\tthis.loadDiv = null;\r\n\t\t\tthis.current = element;\r\n\t\t\tthis.isLoading = false;\r\n\t\t\tthis.isFinished = false;\r\n\t\t\tthis.isHideOver = false;\r\n\t\t\tthis.callback = callback;\r\n\t\t\tthis.params = Object.create(params);\r\n\t\t\tthis.params.numPerPage = params.numPerPage || 10;\r\n\t\t\tthis.defaults = {\r\n\t\t\t\tisFirst: false,\r\n\t\t\t\ttext: '正在努力加载...',\r\n\t\t\t\tovertext: '已经到底了~~',\r\n\t\t\t\timg: wapcsspath + '/images/loading-1.gif'\r\n\t\t\t};\r\n\t\t\tif (options) {\r\n\t\t\t\tthis.isFirst = options.isFirst || false;\r\n\t\t\t\tthis.defaults = Object.assign(this.defaults, options);\r\n\t\t\t}\r\n\t\t\tif (this.defaults.isFirst) {\r\n\t\t\t\tthis.params.pageNum = 1;\r\n\t\t\t\tthis.params.numPerPage = 20;\r\n\t\t\t} else {\r\n\t\t\t\tthis.params.pageNum = params.pageNum || 2;\r\n\t\t\t}\r\n\t\t\tif(this._checkFirstList()){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tthis._addLoading();\r\n\t\t\tif(this.current && this.params.pageNum === 2){\r\n\t\t\t\tif(document.body.scrollTop + window.innerHeight === document.body.offsetHeight){\r\n\t\t\t\t\tthis._loadSource();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t_addListener() {\r\n\t\t\tlet x, y, self = this;\r\n\t\t\tthis.current.addEventListener('touchstart', e => {\r\n\t\t\t\tx = e.changedTouches[0].pageX;\r\n\t\t\t\ty = e.changedTouches[0].pageY;\r\n\t\t\t}, false);\r\n\t\t\tthis.current.addEventListener(\"touchend\", e => {\r\n\t\t\t\tcurrent_element = e.target;\r\n\t\t\t\t// let durationX = e.changedTouches[0].pageX - x;\r\n\t\t\t\tlet durationY = e.changedTouches[0].pageY - y;\r\n\t\t\t\tif (Math.abs(durationY) > 0) {\r\n\t\t\t\t\tself._attachFun();\r\n\t\t\t\t}\r\n\t\t\t}, false);\r\n\t\t\tif (this.defaults.isFirst) {\r\n\t\t\t\tthis._loadSource();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t_attachFun() {\r\n\t\t\tif (this.isFinished) {\r\n\t\t\t\t// this._loadover();\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tif (this.isLoading) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tthis._doLoad();\r\n\t\t}\r\n\r\n\t\t_doLoad() {\r\n\t\t\tlet srollTop = document.body.scrollTop,\r\n\t\t\t\theight = document.body.offsetHeight,\r\n\t\t\t\tinnerH = window.innerHeight,\r\n\t\t\t\trange = parseFloat(innerH) * 2,\r\n\t\t\t\ttotalheight = range + parseFloat(srollTop);\r\n\t\t\tif (totalheight + range >= height) {\r\n\t\t\t\tthis._showLoading();\r\n\t\t\t\tthis._loadSource();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t_loadSource() {\r\n\t\t\tAjax.loadmore(this.url, this.params, this.callback, this._before.bind(this), this._after.bind(this));\r\n\t\t}\r\n\r\n\t\t_before() {\r\n\t\t\tthis._hideLoading();\r\n\t\t}\r\n\r\n\t\t_after() {\r\n\t\t\tthis.params.pageNum++;\r\n\t\t\tsetTimeout(function() {\r\n\t\t\t\tll._lazyload();\r\n\t\t\t}, 300);\r\n\t\t}\r\n\r\n\t\t_addLoading() {\r\n\t\t\tif (this.loadDiv) {\r\n\t\t\t\treturn;\r\n\t\t\t} else {\r\n\t\t\t\tthis._createLoading();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t_createLoading() {\r\n\t\t\tif(this.loadDiv){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (this.current) {\r\n\t\t\t\tlet parent = this.current.parentNode,\r\n\t\t\t\t\tloadDiv = document.createElement('div');\r\n\t\t\t\tloadDiv.className = 'zone-loding page-no';\r\n\t\t\t\tloadDiv.innerHTML = '<img style=\"height: 0.32rem; padding-right: 5px; display: inline-block;\" src=\"' + this.defaults.img + '\" alt=\"\" />' + this.defaults.text;\r\n\t\t\t\tif (this.current.nextSibling) {\r\n\t\t\t\t\tthis.loadDiv = parent.insertBefore(loadDiv, this.current.nextSibling);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.loadDiv = parent.appendChild(loadDiv);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t_showLoading() {\r\n\t\t\tthis.loadDiv.style.display = 'block';\r\n\t\t\tthis.isLoading = true;\r\n\t\t}\r\n\r\n\t\t_hideLoading() {\r\n\t\t\tthis.loadDiv.style.display = 'none';\r\n\t\t\tthis.isLoading = false;\r\n\t\t}\r\n\r\n\t\t_loadover(len) {\r\n\t\t\t//加载完\r\n\t\t\t// if (this.isFinished) {\r\n\t\t\t// \treturn false;\r\n\t\t\t// }\r\n\t\t\tif (this.loadDiv) {\r\n\t\t\t\tthis.loadDiv.innerHTML = this.defaults.overtext;\r\n\t\t\t}\r\n\t\t\tif (this.defaults.isHideOver) {\r\n\t\t\t\tthis.loadDiv.style.display = 'none';\r\n\t\t\t} else {\r\n\t\t\t\tthis.loadDiv.style.display = 'block';\r\n\t\t\t}\r\n\t\t\tif(this.params.pageNum === 1 && len === 0){\r\n\t\t\t\tthis.loadDiv.style.display = 'none';\r\n\t\t\t}\r\n\t\t\tthis.isFinished = true;\r\n\t\t}\r\n\r\n\t\t_checkFirstList(){\r\n\t\t\tif(this.current.tagName.toUpperCase() === 'UL' && !this.defaults.isFirst){\r\n\t\t\t\tvar childCount = 0;\r\n\t\t\t\tArray.prototype.slice.call(this.current.childNodes).map(function(el){\r\n\t\t\t\t\tif(el.nodeType === 1 && el.tagName.toUpperCase() === 'LI'){\r\n\t\t\t\t\t\tchildCount++;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif(childCount < this.params.pageSize){\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tmodule.exports = DropLoad;\r\n})"]}