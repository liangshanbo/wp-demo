{"version":3,"sources":["conf/account/exchange.js"],"names":["define","require","exports","module","$","ajax","Vue","appInterface","Login","init","bindLinkEvent","bindExchangeEvents","click","callWebView","$totalBalance","exchangeStates","shownElementName","cardId","vm","el","data","methods","showExchangePrompt","evt","target","getLoginStatus","call","msg","code","sendExchangeReq","removeMaskAndAlert","post","url","id","success","result","message","fail","checkNetwork","query","newAmount","balance","amount","toFixed","text","toast","waitTime","setTimeout","window","navigator","onLine"],"mappings":"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","file":"../../../../conf/account/exchange.js","sourcesContent":["/**\r\n * 礼品卡兑换 - 内嵌\r\n * @author 张恩铭\r\n * @date 20170324\r\n * 页面引用\r\n *  <script src=\"__PUBLIC__/js/lithe.js\"\r\n data-config=\"config.js\"\r\n data-debug=\"true\"\r\n data-main=\"conf/account/exchange.js\">\r\n </script>\r\n */\r\ndefine('conf/account/exchange.js', function(require, exports, module) {\r\n    const $ = require('$');\r\n    const ajax = require('utils/async/ajax.js');\r\n    const Vue = require('vue');\r\n    const appInterface = require(\"utils/appInterface\");\r\n    const Login = require(\"mods/login/index\");\r\n\r\n    $(init);\r\n\r\n    function init() {\r\n        bindLinkEvent();\r\n        bindExchangeEvents();\r\n    }\r\n\r\n    function bindLinkEvent() {\r\n        $('.link-giftcards').click(function() {\r\n            appInterface.callWebView(\"/account/giftcard\", function() {\r\n                // 没时间搞了，下个迭代再优化\r\n                // Login.getLoginStatus(function() {\r\n                //     window.location.reload();\r\n                // }, function(){});\r\n            });\r\n        });\r\n    }\r\n\r\n    function bindExchangeEvents() {\r\n        let $totalBalance = $('.actual-amount');\r\n        let exchangeStates = {\r\n            // 要显示的遮罩层子元素\r\n            shownElementName: '',\r\n            // 要兑换的卡号\r\n            cardId: '',\r\n            // 协议接口\r\n            appInterface,\r\n        };\r\n        let vm = new Vue({\r\n            el: 'body',\r\n            data: function() {\r\n                return exchangeStates;\r\n            },\r\n            methods: {\r\n                showExchangePrompt(evt) {\r\n                    this.cardId = $(evt.target).data('card-id');\r\n                    Login.getLoginStatus(function() {\r\n                        vm.appInterface.call(\r\n                            '/common/confirm',\r\n                            { msg : 'Exchange this Gift Voucher?' },\r\n                            function(data) {\r\n                                if (data.code === 200) {\r\n                                    vm.sendExchangeReq();\r\n                                } else {\r\n                                    vm.removeMaskAndAlert();\r\n                                }\r\n                            }\r\n                        );\r\n                    },function(){});\r\n                },\r\n                sendExchangeReq() {\r\n                    this.shownElementName = 'loading';\r\n                    ajax.post({\r\n                        url: '/api/trade/myGiftCard',\r\n                        data: {\r\n                            id: vm.cardId\r\n                        },\r\n                        success: function(result) {\r\n                            if (result.code === 200) {\r\n                                vm.removeMaskAndAlert('Exchanged Sucessfully. Check it in My Gift Voucher.');\r\n                            } else {\r\n                                vm.removeMaskAndAlert(result.message);\r\n                            }\r\n                        },\r\n                        fail: function(result) {\r\n                            vm.removeMaskAndAlert('Exchange failed.');\r\n                        },\r\n                    });\r\n                    this.checkNetwork();\r\n                },\r\n                removeMaskAndAlert(msg) {\r\n                    // 移除遮罩层和子元素\r\n                    this.shownElementName = '';\r\n                    // 刷新顶部的总余额\r\n                    ajax.query({\r\n                        url: '/api/trade/giftCards',\r\n                        success: function(result) {\r\n                            let newAmount = (result.data.balance.amount / 100).toFixed(2);\r\n                            $totalBalance.text(newAmount);\r\n                        },\r\n                    });\r\n                    // 有参数时toast之\r\n                    if (typeof msg === 'string') {\r\n                        this.appInterface.toast(msg, 3000);\r\n                    }\r\n                },\r\n                // 断网超时提示\r\n                checkNetwork(waitTime = 3000) {\r\n                    setTimeout(function() {\r\n                        if (!window.navigator.onLine) {\r\n                            vm.removeMaskAndAlert('Please check your network.');\r\n                        };\r\n                    }, waitTime);\r\n                },\r\n            },\r\n        });\r\n    }\r\n\r\n});\r\n"]}