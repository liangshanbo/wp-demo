{"version":3,"sources":["conf/game/luckydraw_core.js"],"names":["define","require","exports","module","Storage","Ajax","internal","dates","loading","date_now","Date","valueOf","$pre","$","$next","$list","$nolist","$date","date_storage","begintime","endtime","DrawCore","init","self","getLogin","ajaxData","bindEvents","on","share","_toggle_date","$dom","type","parent","hasClass","now","data","bounses","str","l","Math","min","length","i","boun","html","show","hide","descr","description","split","find","timestamp","date","year","getFullYear","month","getMonth","day","getDate","hour","getHours","miu","getMinutes","seconds","getSeconds","$now","_get_date","$begin","$end","$rnow","bPre","_get_timestamp","bNext","removeClass","addClass","dd","storage","getItem","join","query","url","queryDate","success","code","result","_handle_data","toast","message","_show_data","beginTime","entTime","bonusTime","_set_btn"],"mappings":"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","file":"../../../../conf/game/luckydraw_core.js","sourcesContent":["/**\r\n * @title: 幸运大抽奖--核心部分\r\n * @time:  2017-04-26\r\n * @author: wangchunpeng\r\n */\r\ndefine(\"conf/game/luckydraw_core\", function(require, exports, module) {\r\n    require(\"$\");\r\n    let Storage = require(\"mods/storage/storage\"),\r\n        Ajax = require(\"utils/async/ajax\");\r\n\r\n    let internal = {\r\n        dates: [\"Apr\", \"May\"],\r\n        loading: false, //是否正在加载list\r\n        date_now: new Date().valueOf(), //当前显示的哪天的数据\r\n        $pre: $(\".pre\"),\r\n        $next: $(\".next\"),\r\n        $list: $(\".main .list\"),\r\n        $nolist: $(\".main .nolist\"),\r\n        $date: $(\".main .date\"),\r\n        date_storage: \"\",\r\n        begintime: \"\", //活动开始时间\r\n        endtime: \"\" //结束时间\r\n    }\r\n    class DrawCore {\r\n        constructor() {\r\n            this.init();\r\n        }\r\n        init() {\r\n            let self = this;\r\n            self.getLogin(function() {\r\n                self.ajaxData();\r\n                self.bindEvents();\r\n            });\r\n        }\r\n        bindEvents() {\r\n            let self = this;\r\n            $(\".share,.share0\").on(\"click\", function() {\r\n                self.share();\r\n            });\r\n            internal.$pre.on(\"click\", function() {\r\n                self._toggle_date(internal.$pre, \"pre\");\r\n            });\r\n            internal.$next.on(\"click\", function() {\r\n                self._toggle_date(internal.$next, \"next\");\r\n            });\r\n        }\r\n        _toggle_date($dom, type) {\r\n            if ($dom.parent().hasClass(\"disabled\") || internal.loading) {\r\n                return;\r\n            }\r\n            let now = internal.date_now,\r\n                self = this;\r\n            if (type == \"next\") {\r\n                now += 24 * 60 * 60 * 1000;\r\n            } else {\r\n                now -= 24 * 60 * 60 * 1000;\r\n            }\r\n            internal.date_now = now;\r\n            self.ajaxData();\r\n        }\r\n        _show_data(data) {\r\n            let bounses = data.bounses;\r\n            if (bounses) {\r\n                let str = \"\",\r\n                    l = Math.min(10, bounses.length);\r\n                for (var i = 0; i < l; i++) {\r\n                    let boun = bounses[i];\r\n                    str += (boun[\"isMe\"] ? \"<li class='active'>\" : \"<li>\") +\r\n                        \"<a href='javascript:void(0)' class='clearfix'>\" +\r\n                        `<span class='uname'>${boun['nickname']}</span>` +\r\n                        `<span class='phone'>${boun['mobile']}</span>` +\r\n                        \"</li>\";\r\n                }\r\n                internal.$list.html(str).show();\r\n                internal.$nolist.hide();\r\n            } else {\r\n                let descr = data.description.split(\".\");\r\n                internal.$nolist.find(\".tip1\").html(descr[0]);\r\n                internal.$nolist.find(\".tip2\").html(descr[1]);\r\n                internal.$list.hide();\r\n                internal.$nolist.show();\r\n            }\r\n        }\r\n        _get_date(timestamp) {\r\n            let date = new Date(timestamp),\r\n                year = date.getFullYear(),\r\n                month = date.getMonth() + 1,\r\n                day = date.getDate(),\r\n                hour = date.getHours(),\r\n                miu = date.getMinutes(),\r\n                seconds = date.getSeconds();\r\n            month = month > 9 ? month : \"0\" + month;\r\n            day = day > 9 ? day : \"0\" + day;\r\n            hour = hour > 9 ? hour : \"0\" + hour;\r\n            miu = miu > 9 ? miu : \"0\" + miu;\r\n            seconds = seconds > 9 ? seconds : \"0\" + seconds;\r\n\r\n            return { year, month, day, hour, miu, seconds };\r\n        }\r\n\r\n        /**\r\n         * @title:设置next pre是否disable\r\n         * bPre： 大于开始时间的第二天\r\n         * bNext：小于结束时间&&小于当前时间\r\n         */\r\n        _set_btn() {\r\n            if (internal.begintime && internal.endtime) {\r\n                let self = this,\r\n                    $now = self._get_date(internal.date_now),\r\n                    $begin = self._get_date(internal.begintime),\r\n                    $end = self._get_date(internal.endtime),\r\n                    $rnow = self._get_date(new Date().valueOf());\r\n\r\n                let bPre = self._get_timestamp($now) > self._get_timestamp($begin),\r\n                    bNext = self._get_timestamp($now) < Math.min(self._get_timestamp($end), self._get_timestamp($rnow));\r\n\r\n                if (bPre) {\r\n                    internal.$pre.parent().removeClass(\"disabled\");\r\n                } else {\r\n                    internal.$pre.parent().addClass(\"disabled\");\r\n                }\r\n                if (bNext) {\r\n                    internal.$next.parent().removeClass(\"disabled\");\r\n                } else {\r\n                    internal.$next.parent().addClass(\"disabled\");\r\n                }\r\n            }\r\n        }\r\n        _get_timestamp($date) {\r\n            return new Date($date.year + \"-\" + $date.month + \"-\" + $date.day).valueOf()\r\n        }\r\n        ajaxData() {\r\n            let self = this;\r\n\r\n            internal.$list.hide();\r\n            internal.$nolist.find(\".tip\").html(\"\");\r\n            internal.$nolist.show();\r\n\r\n            let dd = self._get_date(internal.date_now),\r\n                storage = Storage.getItem(\"luckydraw_\" + internal.date_storage);\r\n            dd = [dd.year, dd.month, dd.day, dd.hour, dd.miu, dd.seconds].join(\"\");\r\n            if (storage) { //优先拿本地存储的数据\r\n                //self._handle_data(storage); //TODO\r\n                //return;\r\n            }\r\n            internal.loading = true;\r\n            Ajax.query({\r\n                url: \"/api/activity/luckydraw/bonuses\",\r\n                data: {\r\n                    queryDate: dd\r\n                },\r\n                success: function(data) {\r\n                    if (data.code === 200) {\r\n                        let result = data.data;\r\n                        self._handle_data(result);\r\n                        if (result.bounses) {\r\n                            //Storage.setItem(\"luckydraw_\" + internal.date_storage, JSON.stringify(result)); //TODO\r\n                        }\r\n                    } else {\r\n                        self.toast(data.message);\r\n                    }\r\n                    internal.loading = false;\r\n                }\r\n            });\r\n        }\r\n        _handle_data(result) {\r\n            let self = this;\r\n            self._show_data(result);\r\n            internal.begintime = result.beginTime;\r\n            internal.endtime = result.entTime;\r\n            if(result.bonusTime) {\r\n                internal.date_now = new Date(result.bonusTime).valueOf();\r\n            }\r\n            self._set_btn();\r\n            let date = self._get_date(internal.date_now),\r\n                str = \"\";\r\n            str += date.month == \"04\" ? internal[\"dates\"][0] : internal[\"dates\"][1];\r\n            str += \".\" + date.day;\r\n            internal.$date.find(\"span\").html(str);\r\n        }\r\n    }\r\n    module.exports = DrawCore;\r\n});\r\n"]}